<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>房屋租售系统 - 注册</title>
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="form-container">
        <h2 style="text-align: center; margin-bottom: 2rem;">房屋租售系统</h2>
        <h3 style="text-align: center; margin-bottom: 1.5rem;">用户注册</h3>

        <form id="registerForm">
            <div class="form-group">
                <label for="username">用户名</label>
                <input id="username" maxlength="20" minlength="3" name="username" placeholder="请输入用户名（3-20个字符）"
                       required type="text">
            </div>

            <div class="form-group">
                <label for="password">密码</label>
                <input id="password" maxlength="20" minlength="6" name="password" placeholder="请输入密码（6-20个字符）"
                       required type="password">
            </div>

            <div class="form-group">
                <label for="confirmPassword">确认密码</label>
                <input id="confirmPassword" name="confirmPassword" placeholder="请再次输入密码" required
                       type="password">
            </div>

            <div class="form-group">
                <label for="role">用户角色</label>
                <select id="role" name="role" required>
                    <option value="">请选择角色</option>
                    <option value="tenant">租客</option>
                    <option value="landlord">房东</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="captcha">验证码</label>
                    <input id="captcha" maxlength="4" name="captcha" placeholder="请输入验证码" required type="text">
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <canvas height="40" id="captchaCanvas" style="cursor: pointer; border: 1px solid #ddd; border-radius: 4px;"
                            width="120"></canvas>
                </div>
            </div>

            <button class="btn" style="width: 100%; margin-bottom: 1rem;" type="submit">注册</button>

            <div style="text-align: center;">
                <p>已有账号？ <a href="login.html" style="color: #ff6b6b;">立即登录</a></p>
            </div>
        </form>
    </div>
</div>

<script src="assets/js/utils.js"></script>
<script>
    // 注册页面JS
    function initRegisterPage() {
        const form = document.getElementById('registerForm');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!validateForm('registerForm')) {
                showMessage('请填写完整信息', 'error');
                return;
            }

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (password !== confirmPassword) {
                showMessage('两次输入的密码不一致', 'error');
                return;
            }

            const userCaptcha = document.getElementById('captcha').value.toLowerCase();
            const realCaptcha = sessionStorage.getItem('captcha');
            if (userCaptcha !== realCaptcha) {
                showMessage('验证码错误', 'error');
                generateCaptcha();
                return;
            }

            // 构造用户数据
            let inputValue = document.getElementById('role').value;
            let role;
            if (inputValue === 'tenant') role = 'TENANT';
            else if (inputValue === 'landlord') role = 'LANDLORD';
            else role = inputValue;
            
            const userData = {
                username: document.getElementById('username').value,
                password: password,
                confirmPassword: confirmPassword,
                role: role
            };

            try {
                const response = await fetch('/api/v1/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (err) {
                console.error(err);
                showMessage('注册失败，请重试', 'error');
            }
        });
    }
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
        // 生成验证码
        generateCaptcha();
        document.getElementById('captchaCanvas').addEventListener('click', generateCaptcha);
        
        // 初始化注册页面
        initRegisterPage();
    });
</script>
</body>
</html>