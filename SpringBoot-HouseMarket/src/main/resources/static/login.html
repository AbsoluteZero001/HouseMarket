<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>房屋租售系统 - 登录</title>
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="form-container">
        <h2 style="text-align: center; margin-bottom: 2rem;">房屋租售系统</h2>
        <h3 style="text-align: center; margin-bottom: 1.5rem;">用户登录</h3>

        <form id="loginForm">
            <div class="form-group">
                <label for="username">用户名</label>
                <input id="username" name="username" placeholder="请输入用户名" required type="text">
            </div>

            <div class="form-group">
                <label for="password">密码</label>
                <input id="password" name="password" placeholder="请输入密码" required type="password">
            </div>

            <div class="form-group">
                <label for="role">用户角色</label>
                <select id="role" name="role" required>
                    <option value="">请选择角色</option>
                    <option value="tenant">租客</option>
                    <option value="landlord">房东</option>
                    <option value="admin">管理员</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="captcha">验证码</label>
                    <input id="captcha" maxlength="4" name="captcha" placeholder="请输入验证码" required type="text">
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <canvas height="40" id="captchaCanvas"
                            style="cursor: pointer; border: 1px solid #ddd; border-radius: 4px;"
                            width="120"></canvas>
                </div>
            </div>

            <button class="btn" style="width: 100%; margin-bottom: 1rem;" type="submit">登录</button>

            <div style="text-align: center;">
                <p>还没有账号？ <a href="register.html" style="color: #ff6b6b;">立即注册</a></p>
            </div>
        </form>
    </div>
</div>

<script src="assets/js/utils.js"></script>
<script>
    function initLoginPage() {
        document.getElementById("loginForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!validateForm("loginForm")) {
                showMessage("请填写完整信息", "error");
                return;
            }

            const userCaptcha = document.getElementById("captcha").value.toLowerCase();
            const realCaptcha = sessionStorage.getItem("captcha");

            if (userCaptcha !== realCaptcha) {
                showMessage("验证码错误", "error");
                generateCaptcha();
                return;
            }

            const formData = new FormData(e.target);
            const data = {
                username: formData.get("username"),
                password: formData.get("password"),
                role: formData.get("role")
            };

            try {
                const response = await fetch("/api/v1/auth/login", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.code !== 200) {
                    showMessage(result.msg || "登录失败", "error");
                    return;
                }

                // 存token和用户信息
                localStorage.setItem("token", result.token);
                localStorage.setItem("user", JSON.stringify(result.data));

                showMessage("登录成功", "success");

                const realRole = result.data.role.toLowerCase();

                setTimeout(() => {
                    if (realRole === "tenant") {
                        window.location.href = "tenant.html";
                    } else if (realRole === "landlord") {
                        window.location.href = "landlord.html";
                    } else if (realRole === "admin") {
                        window.location.href = "admin.html";
                    } else {
                        showMessage("未知角色，无法跳转", "error");
                    }
                }, 1200);

            } catch (e) {
                showMessage("无法连接服务器，请检查后端是否运行", "error");
            }
        });
    }

    // 页面加载完成后初始化
    document.addEventListener("DOMContentLoaded", () => {
        generateCaptcha();
        document.getElementById("captchaCanvas").addEventListener("click", generateCaptcha);
        initLoginPage();
    });
</script>
</body>
</html>