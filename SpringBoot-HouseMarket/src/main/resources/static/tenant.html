<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>房屋租售系统 - 租客主页</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- WebSocket相关库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>

<body>
    <div class="particles-container">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    <div class="decoration decoration-1"></div>
    <div class="decoration decoration-2"></div>
    <header>
        <div class="container">
            <nav>
                <div class="logo">房屋租售系统</div>
                <ul class="nav-links">
                    <li><a class="nav-item active" href="tenant.html">首页</a></li>
                    <li><a class="nav-item" href="#" onclick="showSection('appointment')">预约记录</a></li>
                    <li><a class="nav-item" href="#" onclick="showSection('favorites')">我的收藏</a></li>
                    <li class="user-info" onclick="showModal('profileModal')" style="cursor: pointer;">
                        <span class="username-text">欢迎, <strong id="username"></strong></span>
                        <span class="role-badge" id="userRole"></span>
                        <i class="fas fa-caret-down" style="margin-left: 5px;"></i>
                    </li>
                    <li><a class="btn btn-secondary" href="#" id="logoutBtn">登出</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- 租客首页 -->
        <section class="section active" id="house-search">
            <div
                style="text-align: center; padding: 4rem 0; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); border-radius: 15px; margin: 2rem 0;">
                <h1
                    style="font-size: 3rem; font-weight: bold; margin-bottom: 1rem; background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: glow 2s ease-in-out infinite alternate;">
                    租客中心</h1>
                <p style="font-size: 1.2rem; color: #fff; margin-bottom: 2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    欢迎使用房屋租售系统，找到您理想的房源</p>
            </div>

            <!-- 房源搜索和筛选 -->
            <div class="filter-container">
                <h3 style="margin-bottom: 1.5rem;">房源搜索</h3>

                <form id="searchForm">
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="searchKeyword">关键词</label>
                            <input id="searchKeyword" name="keyword" placeholder="请输入关键词" type="text">
                        </div>

                        <div class="form-group">
                            <label for="searchType">户型</label>
                            <select id="searchType" name="type">
                                <option value="">全部户型</option>
                                <option value="平层">平层</option>
                                <option value="跃层">跃层</option>
                                <option value="错层">错层</option>
                                <option value="复式">复式</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="minArea">最小面积 (㎡)</label>
                            <input id="minArea" min="0" name="minArea" placeholder="最小" type="number">
                        </div>

                        <div class="form-group">
                            <label for="maxArea">最大面积 (㎡)</label>
                            <input id="maxArea" min="0" name="maxArea" placeholder="最大" type="number">
                        </div>
                    </div>

                    <div class="filter-row">
                        <div class="form-group">
                            <label for="minPrice">最低价格 (元/月)</label>
                            <input id="minPrice" min="0" name="minPrice" placeholder="最低" type="number">
                        </div>

                        <div class="form-group">
                            <label for="maxPrice">最高价格 (元/月)</label>
                            <input id="maxPrice" min="0" name="maxPrice" placeholder="最高" type="number">
                        </div>

                        <div class="form-group">
                            <label for="searchAddress">地址</label>
                            <input id="searchAddress" name="address" placeholder="请输入地址" type="text">
                        </div>
                    </div>

                    <div class="filter-row" style="justify-content: flex-end;">
                        <button class="btn" type="submit">搜索</button>
                        <button class="btn btn-secondary" onclick="resetFilters()" style="margin-left: 1rem;"
                            type="reset">
                            重置
                        </button>
                    </div>
                </form>
            </div>

            <!-- 房源列表 -->
            <div style="margin: 2rem 0;">
                <h3>房源列表</h3>
                <div class="house-list" id="houseList">
                    <!-- 房源数据将通过JavaScript动态生成 -->
                </div>

                <!-- 分页 -->
                <ul class="pagination" id="pagination"></ul>
            </div>
        </section>

        <!-- 预约记录 -->
        <section class="section" id="appointment" style="display: none;">
            <h2 style="margin: 2rem 0;">我的预约</h2>

            <div class="card">
                <div class="card-body">
                    <table class="table" id="appointmentTable">
                        <thead>
                            <tr>
                                <th>订单ID</th>
                                <th>房源</th>
                                <th>房东</th>
                                <th>预约时间</th>
                                <th>预约地点</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 预约记录将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 我的收藏 -->
        <section class="section" id="favorites" style="display: none;">
            <div
                style="text-align: center; padding: 2rem 0; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); border-radius: 15px; margin: 2rem 0;">
                <h2
                    style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    我的收藏</h2>
                <p
                    style="font-size: 1rem; color: rgba(255,255,255,0.8); margin-bottom: 1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    这里是您收藏的房源，点击查看详情了解更多信息</p>
            </div>

            <div class="house-list" id="favoritesList">
                <!-- 收藏数据将通过JavaScript动态生成 -->
            </div>
        </section>

        <!-- 个人中心模态框 -->
        <div class="modal" id="profileModal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 style="margin-bottom: 1.5rem;">个人中心</h3>
                <div class="form-container">
                    <h4>个人信息</h4>
                    <form id="profileForm">
                        <div class="form-group">
                            <label for="profileUsername">用户名</label>
                            <input disabled id="profileUsername" name="username" type="text">
                        </div>

                        <div class="form-group">
                            <label for="profileRole">角色</label>
                            <input disabled id="profileRole" name="role" type="text">
                        </div>

                        <div class="form-group">
                            <label for="newPassword">新密码</label>
                            <input id="newPassword" maxlength="20" minlength="6" name="newPassword"
                                placeholder="不修改密码请留空" type="password">
                        </div>

                        <div class="form-group">
                            <label for="confirmNewPassword">确认新密码</label>
                            <input id="confirmNewPassword" name="confirmNewPassword" placeholder="请再次输入新密码"
                                type="password">
                        </div>

                        <button class="btn" type="submit">保存修改</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/utils.js"></script>
    <script>
        // 租客页面JS
        function initTenantPage() {
            // 获取当前用户信息
            const userStr = localStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                if (user && user.id) {
                    document.getElementById('username').textContent = user.username;
                    document.getElementById('profileUsername').value = user.username;
                    document.getElementById('profileRole').value = user.role;
                    document.getElementById('userRole').textContent = user.role;
                } else {
                    // 用户信息无效
                    console.error("用户 ID 无效或不存在");
                    alert("用户信息无效，请重新登录");
                    // 清除无效的用户信息并重定向到登录页面
                    localStorage.removeItem('user');
                    localStorage.removeItem('token');
                    window.location.href = "/login.html";  // 重定向到登录页面
                    return; // 立即返回，不继续执行后续初始化
                }
            } else {
                // 未找到用户信息
                console.error("未找到用户信息");
                alert("未找到用户信息，请重新登录");
                window.location.href = "/login.html";  // 强制跳转到登录页面
                return; // 立即返回，不继续执行后续初始化
            }

            // 初始化房源列表
            initHouseList();

            // 搜索表单提交事件
            document.getElementById('searchForm').addEventListener('submit', (e) => {
                e.preventDefault();
                initHouseList();
            });

            // 初始化收藏列表
            initFavoritesList();

            // 初始化预约记录
            initAppointmentList();
        }

        // 初始化房源列表
        async function initHouseList() {
            // 显示加载进度条
            showProgressBar();

            try {
                const token = localStorage.getItem('token');

                // 获取搜索参数
                const keyword = document.getElementById('searchKeyword').value;
                const type = document.getElementById('searchType').value;
                const minArea = document.getElementById('minArea').value;
                const maxArea = document.getElementById('maxArea').value;
                const minPrice = document.getElementById('minPrice').value;
                const maxPrice = document.getElementById('maxPrice').value;
                const address = document.getElementById('searchAddress').value;

                // 构建查询参数
                let queryParams = new URLSearchParams();
                if (keyword) queryParams.append('keyword', keyword);
                if (type) queryParams.append('type', type);
                if (minArea) queryParams.append('minArea', minArea);
                if (maxArea) queryParams.append('maxArea', maxArea);
                if (minPrice) queryParams.append('minPrice', minPrice);
                if (maxPrice) queryParams.append('maxPrice', maxPrice);
                if (address) queryParams.append('address', address);

                const response = await fetch(`/api/houses?${queryParams.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取房源列表失败');
                }

                const result = await response.json();
                const houses = result.data.houses;

                // 获取收藏状态
                const favorites = await getUserFavorites();
                const favoriteHouseIds = favorites.map(fav => fav.house.id);

                const houseList = document.getElementById('houseList');
                houseList.innerHTML = houses.map(house => {
                    const isFavorited = favoriteHouseIds.includes(house.id);
                    // 处理图片显示
                    let imageUrl = '';
                    if (house.image) {
                        try {
                            const images = JSON.parse(house.image);
                            if (images.length > 0 && images[0]) {
                                imageUrl = images[0];
                            }
                        } catch (e) {
                            console.error('解析图片失败:', e);
                        }
                    }
                    // 如果没有图片URL，使用默认图片
                    if (!imageUrl) {
                        imageUrl = 'https://picsum.photos/seed/house' + house.id + '/300/200';
                    }

                    return `
        <div class="house-card">
            <div class="house-image-container">
                <img src="${imageUrl}" alt="${house.title}" class="house-image">
            </div>
            <div class="house-info">
                <h4 class="house-title">${house.title}</h4>
                <div class="house-price">¥${house.price}/月</div>
                
                <div class="house-params">
                    <div class="house-param-row">
                        <span class="house-param house-type">${house.type}</span>
                        <span class="house-param house-area">${house.area}㎡</span>
                    </div>
                    <div class="house-param house-address">${house.address}</div>
                </div>
                
                <div class="house-actions">
                    <button class="btn" onclick="viewHouseDetail(${house.id})"><i class="fas fa-eye"></i> 查看详情</button>
                    <button class="btn btn-secondary" onclick="bookHouse(${house.id})"><i class="fas fa-calendar-plus"></i> 预约看房</button>
                    <button class="btn ${isFavorited ? 'btn-danger' : 'btn-heart'}" onclick="toggleFavorite(${house.id}, this)">${isFavorited ? '取消收藏' : '收藏'}</button>
                </div>
            </div>
        </div>
    `;
                }).join('');
            } catch (error) {
                console.error('初始化房源列表失败:', error);
                showMessage('获取房源列表失败', 'error');
            } finally {
                // 隐藏加载进度条
                hideProgressBar();
            }
        }

        // 初始化收藏列表
        async function initFavoritesList() {
            // 显示加载进度条
            showProgressBar();

            try {
                const favorites = await getUserFavorites();

                const favoritesList = document.getElementById('favoritesList');

                if (favorites.length === 0) {
                    favoritesList.innerHTML = '<p style="text-align: center; color: #666; margin: 2rem 0;">您还没有收藏任何房源</p>';
                    return;
                }

                // 渲染收藏列表
                favoritesList.innerHTML = favorites.map(fav => {
                    const house = fav.house;
                    // 处理图片显示
                    let imageUrl = '';
                    if (house.image) {
                        try {
                            const images = JSON.parse(house.image);
                            if (images.length > 0 && images[0]) {
                                imageUrl = images[0];
                            }
                        } catch (e) {
                            console.error('解析图片失败:', e);
                        }
                    }
                    // 如果没有图片URL，使用默认图片
                    if (!imageUrl) {
                        imageUrl = 'https://picsum.photos/seed/house' + house.id + '/300/200';
                    }

                    return `
        <div class="house-card">
            <div class="house-image-container">
                <img src="${imageUrl}" alt="${house.title}" class="house-image">
            </div>
            <div class="house-info">
                <h4 class="house-title">${house.title}</h4>
                <div class="house-price">¥${house.price}/月</div>
                
                <div class="house-params">
                    <div class="house-param-row">
                        <span class="house-param house-type">${house.type}</span>
                        <span class="house-param house-area">${house.area}㎡</span>
                    </div>
                    <div class="house-param house-address">${house.address}</div>
                </div>
                
                <div class="house-actions">
                    <button class="btn" onclick="viewHouseDetail(${house.id})"><i class="fas fa-eye"></i> 查看详情</button>
                    <button class="btn btn-secondary" onclick="bookHouse(${house.id})"><i class="fas fa-calendar-plus"></i> 预约看房</button>
                    <button class="btn btn-danger" onclick="toggleFavorite(${house.id}, this)">取消收藏</button>
                </div>
            </div>
        </div>
    `;
                }).join('');
            } catch (error) {
                console.error('初始化收藏列表失败:', error);
                showMessage('获取收藏列表失败', 'error');
            } finally {
                // 隐藏加载进度条
                hideProgressBar();
            }
        }

        // 初始化预约记录
        async function initAppointmentList() {
            // 显示加载进度条
            showProgressBar();

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/appointments', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取预约记录失败');
                }

                const result = await response.json();
                const appointments = result.data.appointments;

                const tbody = document.getElementById('appointmentTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = appointments.map(appointment => `
                <tr class="appointment-row">
                    <td>${appointment.id}</td>
                    <td>${appointment.house?.title || '未知房屋'}</td>
                    <td>${appointment.landlord?.username || '未知房东'}</td>
                    <td>${appointment.time}</td>
                    <td>${appointment.location}</td>
                    <td>
                        <span class="status-badge status-${appointment.status}">${getStatusText(appointment.status)}</span>
                    </td>
                    <td>
                        ${appointment.status === 'pending' ?
                        '<button class="btn btn-danger btn-sm" onclick="cancelAppointment(' + appointment.id + ')">取消预约</button>' :
                        '<button class="btn btn-secondary btn-sm" disabled>查看</button>'
                    }
                    </td>
                </tr>
            `).join('');

                // 添加表格行动画效果
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.style.opacity = '0';
                    row.style.transform = 'translateY(20px)';
                    row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    setTimeout(() => {
                        row.style.opacity = '1';
                        row.style.transform = 'translateY(0)';
                    }, index * 50);
                });
            } catch (error) {
                console.error('初始化预约记录失败:', error);
                showMessage('获取预约记录失败', 'error');
            } finally {
                // 隐藏加载进度条
                hideProgressBar();
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'pending': '待处理',
                'approved': '已批准',
                'rejected': '已拒绝',
                'completed': '已完成',
                'cancelled': '已取消'
            };
            return statusMap[status] || status;
        }

        // 查看房源详情
        function viewHouseDetail(houseId) {
            window.location.href = `house-detail.html?id=${houseId}`;
        }

        // 预约看房
        function bookHouse(houseId) {
            window.location.href = `house-detail.html?id=${houseId}&action=book`;
        }

        // 获取用户收藏列表
        async function getUserFavorites() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/favorites', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取收藏列表失败');
                }

                const result = await response.json();
                return result.data.favorites || [];
            } catch (error) {
                console.error('获取收藏列表失败:', error);
                return [];
            }
        }

        // 切换收藏状态
        async function toggleFavorite(houseId, button) {
            try {
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user'));

                if (button.classList.contains('favorited') || button.textContent === '取消收藏') {
                    // 取消收藏
                    const response = await fetch(`/api/favorites/${houseId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('取消收藏失败');
                    }

                    button.classList.remove('favorited');
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-heart');
                    button.textContent = '收藏';
                    showMessage('取消收藏成功', 'success');
                } else {
                    // 添加收藏
                    const response = await fetch('/api/favorites', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            userId: user.id,
                            houseId: houseId
                        })
                    });

                    if (!response.ok) {
                        throw new Error('添加收藏失败');
                    }

                    button.classList.add('favorited');
                    button.classList.remove('btn-heart');
                    button.classList.add('btn-danger');
                    button.textContent = '取消收藏';
                    showMessage('收藏成功', 'success');
                }

                // 更新收藏列表，无论当前显示的是哪个页面
                initFavoritesList();
            } catch (error) {
                console.error('切换收藏状态失败:', error);
                showMessage(error.message, 'error');
            }
        }

        // 取消预约
        async function cancelAppointment(appointmentId) {
            if (confirm('确定要取消这个预约吗？')) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`/api/appointments/${appointmentId}/cancel`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('取消预约失败');
                    }

                    showMessage('预约已取消', 'success');
                    initAppointmentList();
                } catch (error) {
                    console.error('取消预约失败:', error);
                    showMessage(error.message, 'error');
                }
            }
        }

        // 重置筛选条件
        function resetFilters() {
            document.getElementById('searchForm').reset();
            initHouseList();
        }

        // WebSocket连接
        let stompClient = null;

        // 建立WebSocket连接
        function connectWebSocket() {
            console.log('Attempting to connect WebSocket...');
            // 使用相对路径，自动匹配当前域名和端口
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            // 启用调试模式
            stompClient.debug = function (str) {
                console.log('STOMP debug: ' + str);
            };

            stompClient.connect({}, (frame) => {
                console.log('Connected: ' + frame);
                showMessage('WebSocket连接成功', 'success');

                // 订阅预约状态变更通知
                stompClient.subscribe('/user/queue/appointment', (message) => {
                    console.log('Received message: ' + message.body);
                    const data = JSON.parse(message.body);
                    // 更新预约状态
                    updateAppointmentStatus(data.appointmentId, data.status);
                    // 显示消息提示
                    showMessage(data.message || '预约状态已更新', 'success');
                });
            }, (error) => {
                console.error('WebSocket连接失败: ' + error);
                // 显示错误消息
                showMessage('WebSocket连接失败，将尝试重新连接', 'error');
                // 3秒后重试连接
                setTimeout(connectWebSocket, 3000);
            });
        }

        // 更新预约状态
        function updateAppointmentStatus(appointmentId, status) {
            // 查找对应的预约行
            const tbody = document.getElementById('appointmentTable').getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const idCell = row.cells[0];
                if (parseInt(idCell.textContent) === appointmentId) {
                    // 更新状态列
                    const statusCell = row.cells[5];
                    statusCell.innerHTML = `<span class="status-badge status-${status}">${getStatusText(status)}</span>`;

                    // 更新操作列
                    const actionCell = row.cells[6];
                    if (status === 'approved' || status === 'rejected') {
                        actionCell.innerHTML = '<button class="btn btn-secondary btn-sm" disabled>查看</button>';
                    }

                    // 添加动画效果
                    row.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 2000);

                    break;
                }
            }

            // 如果当前显示的是预约记录页面，重新初始化预约列表
            const appointmentSection = document.getElementById('appointment');
            if (appointmentSection && appointmentSection.style.display !== 'none') {
                initAppointmentList();
            }
        }

        // 重写showSection函数，添加收藏列表和预约记录初始化
        window.showSection = function (sectionId) {
            // 隐藏所有section
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // 显示指定section
            document.getElementById(sectionId).style.display = 'block';

            // 更新导航激活状态
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
            });

            // 如果是导航链接，添加激活状态
            const activeLink = document.querySelector(`.nav-links a[onclick="showSection('${sectionId}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // 如果切换到收藏列表，初始化收藏列表
            if (sectionId === 'favorites') {
                initFavoritesList();
            }

            // 如果切换到预约记录，初始化预约记录
            if (sectionId === 'appointment') {
                initAppointmentList();
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            initTenantPage();

            // 初始化模态框
            initModals();

            // 建立WebSocket连接
            connectWebSocket();

            // 登出按钮事件
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // 断开WebSocket连接
                    if (stompClient) {
                        stompClient.disconnect();
                    }
                    logout();
                });
            }
        });
    </script>
</body>

</html>