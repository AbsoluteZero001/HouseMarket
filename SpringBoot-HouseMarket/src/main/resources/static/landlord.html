<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>房屋租售系统 - 房东主页</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<div class="particles-container">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>
<div class="decoration decoration-1"></div>
<div class="decoration decoration-2"></div>
<header>
    <div class="container">
        <nav>
            <div class="logo">房屋租售系统</div>
            <ul class="nav-links">
                <li><a class="active" href="landlord.html">首页</a></li>
                <li><a href="#" onclick="showSection('house-manage')">房源管理 <span class="badge">2</span></a></li>
                <li><a href="#" onclick="showSection('appointment')">预约记录 <span class="badge">4</span></a></li>
                <li><a href="#" onclick="showSection('profile')">个人中心</a></li>
                <li><span id="username"></span></li>
                <li><a class="btn btn-secondary" href="#" id="logoutBtn">登出</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="container">
    <!-- 房东首页 -->
    <section class="section active" id="dashboard">
        <h2 style="margin: 2rem 0;">房东首页</h2>
        <p>欢迎使用房屋租售系统房东后台</p>
    </section>

    <!-- 房源管理 -->
    <section class="section" id="house-manage" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0;">
            <h2>房源管理</h2>
            <button class="btn" onclick="showModal('addHouseModal')">发布新房源</button>
        </div>

        <div class="card">
            <div class="card-body">
                <table class="table" id="houseTable">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>标题</th>
                        <th>户型</th>
                        <th>面积</th>
                        <th>价格</th>
                        <th>地址</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 房源数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- 预约记录 -->
    <section class="section" id="appointment" style="display: none;">
        <h2 style="margin: 2rem 0;">预约记录</h2>

        <div class="card">
            <div class="card-body">
                <table class="table" id="appointmentTable">
                    <thead>
                    <tr>
                        <th>订单ID</th>
                        <th>房源</th>
                        <th>租客</th>
                        <th>预约时间</th>
                        <th>预约地点</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 预约记录将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- 个人中心 -->
    <section class="section" id="profile" style="display: none;">
        <h2 style="margin: 2rem 0;">个人中心</h2>

        <div class="form-container">
            <h3>个人信息</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileUsername">用户名</label>
                    <input disabled id="profileUsername" name="username" type="text">
                </div>

                <div class="form-group">
                    <label for="profileRole">角色</label>
                    <input disabled id="profileRole" name="role" type="text">
                </div>

                <div class="form-group">
                    <label for="newPassword">新密码</label>
                    <input id="newPassword" maxlength="20" minlength="6" name="newPassword"
                           placeholder="不修改密码请留空" type="password">
                </div>

                <div class="form-group">
                    <label for="confirmNewPassword">确认新密码</label>
                    <input id="confirmNewPassword" name="confirmNewPassword" placeholder="请再次输入新密码"
                           type="password">
                </div>

                <button class="btn" type="submit">保存修改</button>
            </form>
        </div>
    </section>
</div>

<!-- 添加房源模态框 -->
<div class="modal" id="addHouseModal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 style="margin-bottom: 1.5rem;">发布新房源</h3>

        <form id="addHouseForm">
            <div class="form-group">
                <label for="houseTitle">标题</label>
                <input id="houseTitle" name="title" placeholder="请输入房源标题" required type="text">
            </div>

            <div class="form-group">
                <label for="houseType">户型</label>
                <select id="houseType" name="type" required>
                    <option value="">请选择户型</option>
                    <option value="平层">平层</option>
                    <option value="跃层">跃层</option>
                    <option value="错层">错层</option>
                    <option value="复式">复式</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="houseArea">面积 (㎡)</label>
                    <input id="houseArea" min="1" name="area" placeholder="请输入面积" required type="number">
                </div>

                <div class="form-group">
                    <label for="housePrice">价格 (元/月)</label>
                    <input id="housePrice" min="1" name="price" placeholder="请输入价格" required type="number">
                </div>
            </div>

            <div class="form-group">
                <label for="houseAddress">地址</label>
                <input id="houseAddress" name="address" placeholder="请输入详细地址" required type="text">
            </div>

            <div class="form-group">
                <label for="houseImage">图片</label>
                <input accept="image/*" id="houseImage" name="image" type="file">
                <img alt="图片预览" id="imagePreview" src="" 
                     style="display: none; max-width: 100%; margin-top: 1rem; border-radius: 4px;">
            </div>

            <div class="form-group">
                <label for="houseDescription">描述</label>
                <textarea id="houseDescription" name="description" placeholder="请输入房源描述" rows="4"></textarea>
            </div>

            <button class="btn" style="width: 100%; margin-top: 1rem;" type="submit">发布房源</button>
        </form>
    </div>
</div>

<!-- 编辑房源模态框 -->
<div class="modal" id="editHouseModal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 style="margin-bottom: 1.5rem;">编辑房源</h3>

        <form id="editHouseForm">
            <input id="editHouseId" name="id" type="hidden">

            <div class="form-group">
                <label for="editHouseTitle">标题</label>
                <input id="editHouseTitle" name="title" placeholder="请输入房源标题" required type="text">
            </div>

            <div class="form-group">
                <label for="editHouseType">户型</label>
                <select id="editHouseType" name="type" required>
                    <option value="">请选择户型</option>
                    <option value="平层">平层</option>
                    <option value="跃层">跃层</option>
                    <option value="错层">错层</option>
                    <option value="复式">复式</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editHouseArea">面积 (㎡)</label>
                    <input id="editHouseArea" min="1" name="area" placeholder="请输入面积" required type="number">
                </div>

                <div class="form-group">
                    <label for="editHousePrice">价格 (元/月)</label>
                    <input id="editHousePrice" min="1" name="price" placeholder="请输入价格" required type="number">
                </div>
            </div>

            <div class="form-group">
                <label for="editHouseAddress">地址</label>
                <input id="editHouseAddress" name="address" placeholder="请输入详细地址" required type="text">
            </div>

            <div class="form-group">
                <label for="editHouseImage">图片</label>
                <input accept="image/*" id="editHouseImage" name="image" type="file">
                <img alt="图片预览" id="editImagePreview" src="" 
                     style="display: none; max-width: 100%; margin-top: 1rem; border-radius: 4px;">
            </div>

            <div class="form-group">
                <label for="editHouseDescription">描述</label>
                <textarea id="editHouseDescription" name="description" placeholder="请输入房源描述" rows="4"></textarea>
            </div>

            <button class="btn" style="width: 100%; margin-top: 1rem;" type="submit">保存修改</button>
        </form>
    </div>
</div>

<script src="assets/js/utils.js"></script>
<script>
    function initLandlordPage() {
        // 获取当前用户信息
        const userStr = localStorage.getItem('user');
        if (userStr) {
            const user = JSON.parse(userStr);
            if (user && user.id) {
                // 如果用户信息有效，继续初始化页面内容
                document.getElementById('username').textContent = user.username;
                initHouseList(user.id);  // 传递有效的 user.id
            } else {
                // 用户信息无效
                console.error("用户 ID 无效或不存在");
                alert("用户信息无效，请重新登录");
                // 清除无效的用户信息并重定向到登录页面
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                window.location.href = "/login.html";  // 重定向到登录页面
            }
        } else {
            // 未找到用户信息
            console.error("未找到用户信息");
            alert("未找到用户信息，请重新登录");
            window.location.href = "/login.html";  // 强制跳转到登录页面
        }

        // 初始化预约记录
        initAppointmentList();

        // 初始化图片预览
        initImagePreview('houseImage', 'imagePreview');
        initImagePreview('editHouseImage', 'editImagePreview');

        // 绑定表单提交事件
        bindFormEvents();
    }

    // 初始化房源列表
    async function initHouseList(userId) {
        // 显示加载进度条
        showProgressBar();
        
        try {
            const token = localStorage.getItem('token');

            // 获取房东自己的房源列表
            const response = await fetch(`/api/houses/landlord/${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('获取房源列表失败');
            }

            const houses = await response.json();

            const tbody = document.getElementById('houseTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = houses.map(house => `
                <tr>
                    <td>${house.id}</td>
                    <td>${house.title}</td>
                    <td>${house.type}</td>
                    <td>${house.area}㎡</td>
                    <td>¥${house.price}/月</td>
                    <td>${house.address}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editHouse(${house.id})">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteHouse(${house.id})" style="margin-left: 0.5rem;">删除</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('初始化房源列表失败:', error);
            showMessage('获取房源列表失败', 'error');
        } finally {
            // 隐藏加载进度条
            hideProgressBar();
        }
    }

    // 初始化预约记录
    async function initAppointmentList() {
        // 显示加载进度条
        showProgressBar();
        
        try {
            // 模拟预约数据
            const appointments = [
                {
                    id: 1,
                    house: '阳光小区 3室2厅',
                    tenant: '张三',
                    time: '2025-12-01 14:00',
                    location: '小区门口',
                    status: '待处理'
                },
                {
                    id: 2,
                    house: '幸福家园 2室1厅',
                    tenant: '李四',
                    time: '2025-12-02 10:00',
                    location: '单元门口',
                    status: '已批准'
                }
            ];

            const tbody = document.getElementById('appointmentTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = appointments.map(appointment => `
                <tr>
                    <td>${appointment.id}</td>
                    <td>${appointment.house}</td>
                    <td>${appointment.tenant}</td>
                    <td>${appointment.time}</td>
                    <td>${appointment.location}</td>
                    <td>${appointment.status}</td>
                    <td>
                        ${appointment.status === '待处理' ?
                '<button class="btn btn-success btn-sm" onclick="approveAppointment(' + appointment.id + ')">批准</button>' +
                '<button class="btn btn-danger btn-sm" onclick="rejectAppointment(' + appointment.id + ')" style="margin-left: 0.5rem;">拒绝</button>' :
                '<button class="btn btn-secondary btn-sm" disabled>查看</button>'
            }
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('初始化预约记录失败:', error);
            showMessage('获取预约记录失败', 'error');
        } finally {
            // 隐藏加载进度条
            hideProgressBar();
        }
    }

    // 获取房源详情
    async function getHouseDetails(houseId) {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/houses/${houseId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('获取房源详情失败');
        }

        const result = await response.json();
        return result.data.house;
    }

    // 编辑房源
    async function editHouse(houseId) {
        try {
            const house = await getHouseDetails(houseId);
            
            // 填充表单数据
            document.getElementById('editHouseId').value = house.id;
            document.getElementById('editHouseTitle').value = house.title;
            document.getElementById('editHouseType').value = house.type;
            document.getElementById('editHouseArea').value = house.area;
            document.getElementById('editHousePrice').value = house.price;
            document.getElementById('editHouseAddress').value = house.address;
            document.getElementById('editHouseDescription').value = house.description || '';
            
            // 如果有图片，显示预览
            if (house.image) {
                document.getElementById('editImagePreview').src = house.image;
                document.getElementById('editImagePreview').style.display = 'block';
            }
            
            showModal('editHouseModal');
        } catch (error) {
            console.error('编辑房源失败:', error);
            showMessage('获取房源详情失败', 'error');
        }
    }

    // 删除房源
    async function deleteHouse(houseId) {
        if (confirm('确定要删除这套房源吗？')) {
            try {
                showProgressBar();
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/houses/${houseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('删除房源失败');
                }

                showMessage('房源删除成功', 'success');
                initHouseList();
            } catch (error) {
                console.error('删除房源失败:', error);
                showMessage('删除房源失败', 'error');
            } finally {
                hideProgressBar();
            }
        }
    }

    // 新增房源
    async function addHouse() {
        try {
            showProgressBar();
            
            const form = document.getElementById('addHouseForm');
            const formData = new FormData(form);
            
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));
            
            // 构建请求数据
            const houseData = {
                title: formData.get('title'),
                type: formData.get('type'),
                area: parseFloat(formData.get('area')),
                price: parseFloat(formData.get('price')),
                address: formData.get('address'),
                description: formData.get('description'),
                image: '' // 添加图片字段
            };

            // 如果有图片文件，处理图片上传
            const imageFile = document.getElementById('houseImage').files[0];
            if (imageFile) {
                // 这里可以实现图片上传到服务器的逻辑
                // 暂时只处理图片预览，实际图片上传需要后端支持
                const imageUrl = URL.createObjectURL(imageFile);
                houseData.image = imageUrl; // 设置图片URL
            }
            
            const response = await fetch('/api/houses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(houseData)
            });

            if (!response.ok) {
                throw new Error('发布房源失败');
            }

            showMessage('发布房源成功', 'success');
            hideModal('addHouseModal');
            form.reset();
            initHouseList();
        } catch (error) {
            console.error('新增房源失败:', error);
            showMessage('发布房源失败', 'error');
        } finally {
            hideProgressBar();
        }
    }

    // 更新房源
    async function updateHouse() {
        try {
            showProgressBar();
            
            const form = document.getElementById('editHouseForm');
            const formData = new FormData(form);
            
            const token = localStorage.getItem('token');
            const houseId = formData.get('id');
            
            // 构建请求数据
            const houseData = {
                title: formData.get('title'),
                type: formData.get('type'),
                area: parseFloat(formData.get('area')),
                price: parseFloat(formData.get('price')),
                address: formData.get('address'),
                description: formData.get('description'),
                image: '' // 添加图片字段
            };

            // 如果有图片文件，处理图片上传
            const imageFile = document.getElementById('editHouseImage').files[0];
            if (imageFile) {
                // 这里可以实现图片上传到服务器的逻辑
                // 暂时只处理图片预览，实际图片上传需要后端支持
                const imageUrl = URL.createObjectURL(imageFile);
                houseData.image = imageUrl; // 设置图片URL
            }
            
            const response = await fetch(`/api/houses/${houseId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(houseData)
            });

            if (!response.ok) {
                throw new Error('更新房源失败');
            }

            showMessage('更新房源成功', 'success');
            hideModal('editHouseModal');
            initHouseList();
        } catch (error) {
            console.error('更新房源失败:', error);
            showMessage('更新房源失败', 'error');
        } finally {
            hideProgressBar();
        }
    }

    // 批准预约
    function approveAppointment(appointmentId) {
        showMessage('预约已批准', 'success');
        initAppointmentList();
    }

    // 拒绝预约
    function rejectAppointment(appointmentId) {
        showMessage('预约已拒绝', 'success');
        initAppointmentList();
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
        initLandlordPage();
        
        // 初始化模态框
        initModals();
        
        // 登出按钮事件
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
        }
    });
</script>
</body>
</html>