<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>房屋租售系统 - 房东主页</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
<div class="particles-container">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>
<div class="decoration decoration-1"></div>
<div class="decoration decoration-2"></div>
<header>
    <div class="container">
        <nav>
            <div class="logo">房屋租售系统</div>
            <ul class="nav-links">
                <li><a class="active" href="landlord.html">首页</a></li>
                <li><a href="#" onclick="showSection('house-manage')">房源管理 <span class="badge">2</span></a></li>
                <li><a href="#" onclick="showSection('appointment')">预约记录 <span class="badge">4</span></a></li>
                <li><a href="#" onclick="showSection('profile')">个人中心</a></li>
                <li><span id="username"></span></li>
                <li><a class="btn btn-secondary" href="#" id="logoutBtn">登出</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="container">
    <!-- 房东首页 -->
    <section class="section active" id="dashboard">
        <div
                style="text-align: center; padding: 4rem 0; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); border-radius: 15px; margin: 2rem 0;">
            <h1
                    style="font-size: 3rem; font-weight: bold; margin-bottom: 1rem; background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: glow 2s ease-in-out infinite alternate;">
                房东管理中心</h1>
            <p style="font-size: 1.2rem; color: #fff; margin-bottom: 2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                欢迎使用房屋租售系统房东后台</p>
            <div style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap;">
                <button class="btn" onclick="showSection('house-manage')"
                        style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">房源管理
                </button>
                <button class="btn btn-secondary" onclick="showSection('appointment')"
                        style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">预约记录
                </button>
                <button class="btn" onclick="showSection('profile')"
                        style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">个人中心
                </button>
            </div>
        </div>
    </section>

    <!-- 房源管理 -->
    <section class="section" id="house-manage" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0;">
            <h2>房源管理</h2>
            <button class="btn" onclick="showModal('addHouseModal')">发布新房源</button>
        </div>

        <div class="house-list" id="houseList">
            <!-- 房源数据将通过JavaScript动态生成为卡片形式 -->
        </div>
    </section>

    <!-- 预约记录 -->
    <section class="section" id="appointment" style="display: none;">
        <h2 style="margin: 2rem 0;">预约记录</h2>

        <div class="card">
            <div class="card-body">
                <table class="table" id="appointmentTable">
                    <thead>
                    <tr>
                        <th>订单ID</th>
                        <th>房源</th>
                        <th>租客</th>
                        <th>预约时间</th>
                        <th>预约地点</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 预约记录将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- 个人中心 -->
    <section class="section" id="profile" style="display: none;">
        <h2 style="margin: 2rem 0;">个人中心</h2>

        <div class="form-container">
            <h3>个人信息</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileUsername">用户名</label>
                    <input disabled id="profileUsername" name="username" type="text">
                </div>

                <div class="form-group">
                    <label for="profileRole">角色</label>
                    <input disabled id="profileRole" name="role" type="text">
                </div>

                <div class="form-group">
                    <label for="oldPassword">当前密码</label>
                    <input id="oldPassword" name="oldPassword" placeholder="请输入当前密码" type="password">
                </div>

                <div class="form-group">
                    <label for="newPassword">新密码</label>
                    <input id="newPassword" maxlength="20" minlength="6" name="newPassword"
                           placeholder="不修改密码请留空"
                           type="password">
                </div>

                <div class="form-group">
                    <label for="confirmNewPassword">确认新密码</label>
                    <input id="confirmNewPassword" name="confirmNewPassword" placeholder="请再次输入新密码"
                           type="password">
                </div>

                <button class="btn" type="submit">保存修改</button>
            </form>
        </div>
    </section>
</div>

<!-- 添加房源模态框 -->
<div class="modal" id="addHouseModal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 style="margin-bottom: 1.5rem;">发布新房源</h3>

        <form id="addHouseForm">
            <div class="form-group">
                <label for="houseTitle">标题</label>
                <input id="houseTitle" name="title" placeholder="请输入房源标题" required type="text">
            </div>

            <div class="form-group">
                <label for="houseType">户型</label>
                <select id="houseType" name="type" required>
                    <option value="">请选择户型</option>
                    <option value="平层">平层</option>
                    <option value="跃层">跃层</option>
                    <option value="错层">错层</option>
                    <option value="复式">复式</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="houseArea">面积 (㎡)</label>
                    <input id="houseArea" min="1" name="area" placeholder="请输入面积" required type="number">
                </div>

                <div class="form-group">
                    <label for="housePrice">价格 (元/月)</label>
                    <input id="housePrice" min="1" name="price" placeholder="请输入价格" required type="number">
                </div>
            </div>

            <div class="form-group">
                <label for="houseAddress">地址</label>
                <input id="houseAddress" name="address" placeholder="请输入详细地址" required type="text">
            </div>

            <div class="form-group">
                <label for="houseImage">图片</label>
                <input accept="image/*" id="houseImage" name="image" type="file">
                <img alt="图片预览" id="imagePreview" src=""
                     style="display: none; max-width: 100%; margin-top: 1rem; border-radius: 4px;">
            </div>

            <div class="form-group">
                <label for="houseDescription">描述</label>
                <textarea id="houseDescription" name="description" placeholder="请输入房源描述" rows="4"></textarea>
            </div>

            <button class="btn" style="width: 100%; margin-top: 1rem;" type="submit">发布房源</button>
        </form>
    </div>
</div>

<!-- 编辑房源模态框 -->
<div class="modal" id="editHouseModal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 style="margin-bottom: 1.5rem;">编辑房源</h3>

        <form id="editHouseForm">
            <input id="editHouseId" name="id" type="hidden">

            <div class="form-group">
                <label for="editHouseTitle">标题</label>
                <input id="editHouseTitle" name="title" placeholder="请输入房源标题" required type="text">
            </div>

            <div class="form-group">
                <label for="editHouseType">户型</label>
                <select id="editHouseType" name="type" required>
                    <option value="">请选择户型</option>
                    <option value="平层">平层</option>
                    <option value="跃层">跃层</option>
                    <option value="错层">错层</option>
                    <option value="复式">复式</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editHouseArea">面积 (㎡)</label>
                    <input id="editHouseArea" min="1" name="area" placeholder="请输入面积" required type="number">
                </div>

                <div class="form-group">
                    <label for="editHousePrice">价格 (元/月)</label>
                    <input id="editHousePrice" min="1" name="price" placeholder="请输入价格" required type="number">
                </div>
            </div>

            <div class="form-group">
                <label for="editHouseAddress">地址</label>
                <input id="editHouseAddress" name="address" placeholder="请输入详细地址" required type="text">
            </div>

            <div class="form-group">
                <label for="editHouseImage">图片</label>
                <input accept="image/*" id="editHouseImage" name="image" type="file">
                <img alt="图片预览" id="editImagePreview" src=""
                     style="display: none; max-width: 100%; margin-top: 1rem; border-radius: 4px;">
            </div>

            <div class="form-group">
                <label for="editHouseDescription">描述</label>
                <textarea id="editHouseDescription" name="description" placeholder="请输入房源描述" rows="4"></textarea>
            </div>

            <button class="btn" style="width: 100%; margin-top: 1rem;" type="submit">保存修改</button>
        </form>
    </div>
</div>

<script src="assets/js/utils.js"></script>
<script>
    function initLandlordPage() {
        // 获取当前用户信息
        const userStr = localStorage.getItem('user');
        if (userStr) {
            const user = JSON.parse(userStr);
            if (user && user.id) {
                // 如果用户信息有效，继续初始化页面内容
                document.getElementById('username').textContent = user.username;
                initHouseList(user.id);  // 传递有效的 user.id
            } else {
                // 用户信息无效
                console.error("用户 ID 无效或不存在");
                alert("用户信息无效，请重新登录");
                // 清除无效的用户信息并重定向到登录页面
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                window.location.href = "/login.html";  // 重定向到登录页面
            }
        } else {
            // 未找到用户信息
            console.error("未找到用户信息");
            alert("未找到用户信息，请重新登录");
            window.location.href = "/login.html";  // 强制跳转到登录页面
        }

        // 初始化预约记录
        initAppointmentList();

        // 初始化图片预览
        initImagePreview('houseImage', 'imagePreview');
        initImagePreview('editHouseImage', 'editImagePreview');

        // 绑定表单提交事件
        bindFormEvents();
    }

    // 绑定表单提交事件
    function bindFormEvents() {
        // 绑定新增房源表单
        const addHouseForm = document.getElementById('addHouseForm');
        if (addHouseForm) {
            addHouseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await addHouse();
            });
        }

        // 绑定编辑房源表单
        const editHouseForm = document.getElementById('editHouseForm');
        if (editHouseForm) {
            editHouseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateHouse();
            });
        }
    }

    // 初始化房源列表
    async function initHouseList(userId) {
        // 显示加载进度条
        showProgressBar();

        try {
            const token = localStorage.getItem('token');

            // 获取房东自己的房源列表
            const response = await fetch(`/api/houses/landlord/${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('获取房源列表失败:', errorText);
                throw new Error('获取房源列表失败');
            }

            const result = await response.json();
            console.log('房源列表响应:', result);

            const houses = result.data?.houses || [];

            const houseList = document.getElementById('houseList');

            if (houses.length === 0) {
                houseList.innerHTML = `
                    <div style="text-align: center; padding: 4rem 0; background: rgba(255,255,255,0.05); border-radius: 15px;">
                        <h3 style="color: #fff; margin-bottom: 1rem;">暂无房源数据</h3>
                        <p style="color: rgba(255,255,255,0.7);">点击"发布新房源"按钮添加您的第一套房源吧！</p>
                    </div>
                `;
            } else {
                houseList.innerHTML = houses.map(house => {
                    // 处理图片显示
                    let imageUrl = 'https://picsum.photos/seed/house' + house.id + '/400/300';
                    if (house.images) {
                        try {
                            const imagesArray = JSON.parse(house.images);
                            if (imagesArray && imagesArray.length > 0 && imagesArray[0]) {
                                imageUrl = imagesArray[0];
                            }
                        } catch (e) {
                            console.error('解析图片数组失败:', e);
                        }
                    }

                    // 处理描述显示，限制长度
                    const description = house.description || '无描述';
                    const truncatedDesc = description.length > 100 ? description.substring(0, 100) + '...' : description;

                    return `
                        <div class="house-card">
                            <img src="${imageUrl}" alt="${house.title}" class="house-image" style="height: 250px; object-fit: cover;">
                            <div class="house-info">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <h4 class="house-title">${house.title}</h4>
                                    <span class="house-price">¥${house.price}/月</span>
                                </div>
                                <div class="house-meta">
                                    <span>户型：${house.type}</span>
                                    <span>面积：${house.area}㎡</span>
                                </div>
                                <div class="house-address" style="margin: 0.5rem 0;">${house.address}</div>
                                <div class="house-description" style="margin: 0.5rem 0; color: #666; font-size: 0.9rem; line-height: 1.4;">${truncatedDesc}</div>
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary btn-sm" onclick="editHouse(${house.id})" style="flex: 1;">编辑</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteHouse(${house.id})" style="flex: 1;">删除</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('初始化房源列表失败:', error);
            showMessage('获取房源列表失败', 'error');
            // 显示空状态
            const houseList = document.getElementById('houseList');
            houseList.innerHTML = `
                <div style="text-align: center; padding: 4rem 0; background: rgba(255,255,255,0.05); border-radius: 15px;">
                    <h3 style="color: #fff; margin-bottom: 1rem;">获取房源失败</h3>
                    <p style="color: rgba(255,255,255,0.7);">请稍后重试或检查网络连接</p>
                </div>
            `;
        } finally {
            // 隐藏加载进度条
            hideProgressBar();
        }
    }

    // 初始化预约记录
    async function initAppointmentList() {
        // 显示加载进度条
        showProgressBar();

        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/appointments', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('获取预约记录失败');
            }

            const result = await response.json();
            const appointments = result.data.appointments;

            const tbody = document.getElementById('appointmentTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = appointments.map(appointment => `
                <tr>
                    <td>${appointment.id}</td>
                    <td>${appointment.house.title}</td>
                    <td>${appointment.tenant.username}</td>
                    <td>${appointment.appointmentTime}</td>
                    <td>${appointment.location}</td>
                    <td>${getStatusText(appointment.status)}</td>
                    <td>
                        ${appointment.status === 'pending' ?
                '<button class="btn btn-success btn-sm" onclick="approveAppointment(' + appointment.id + ')">批准</button>' +
                '<button class="btn btn-danger btn-sm" onclick="rejectAppointment(' + appointment.id + ')" style="margin-left: 0.5rem;">拒绝</button>' :
                '<button class="btn btn-secondary btn-sm" disabled>查看</button>'
            }
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('初始化预约记录失败:', error);
            showMessage('获取预约记录失败', 'error');
            // 显示空状态
            const tbody = document.getElementById('appointmentTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">获取预约记录失败，请稍后重试</td>
                    </tr>
                `;
        } finally {
            // 隐藏加载进度条
            hideProgressBar();
        }
    }

    // 获取状态文本
    function getStatusText(status) {
        const statusMap = {
            'pending': '待处理',
            'approved': '已批准',
            'rejected': '已拒绝',
            'completed': '已完成',
            'cancelled': '已取消'
        };
        return statusMap[status] || status;
    }

    // 获取房源详情
    async function getHouseDetails(houseId) {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/houses/${houseId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('获取房源详情失败');
        }

        const result = await response.json();
        return result.data.house;
    }

    // 编辑房源
    async function editHouse(houseId) {
        try {
            const house = await getHouseDetails(houseId);

            // 填充表单数据
            document.getElementById('editHouseId').value = house.id;
            document.getElementById('editHouseTitle').value = house.title;
            document.getElementById('editHouseType').value = house.type;
            document.getElementById('editHouseArea').value = house.area;
            document.getElementById('editHousePrice').value = house.price;
            document.getElementById('editHouseAddress').value = house.address;
            document.getElementById('editHouseDescription').value = house.description || '';

            // 如果有图片，显示预览
            if (house.images) {
                try {
                    const imagesArray = JSON.parse(house.images);
                    if (imagesArray && imagesArray.length > 0) {
                        document.getElementById('editImagePreview').src = imagesArray[0];
                        document.getElementById('editImagePreview').style.display = 'block';
                    }
                } catch (e) {
                    console.error('解析图片数组失败:', e);
                }
            }

            showModal('editHouseModal');
        } catch (error) {
            console.error('编辑房源失败:', error);
            showMessage('获取房源详情失败', 'error');
        }
    }

    // 删除房源
    async function deleteHouse(houseId) {
        if (confirm('确定要删除这套房源吗？')) {
            try {
                showProgressBar();
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user'));

                const response = await fetch(`/api/houses/${houseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                // 记录响应信息
                const responseText = await response.text();
                console.log('删除响应状态:', response.status);
                console.log('删除响应内容:', responseText);

                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                    console.log('解析后的删除响应:', responseData);
                } catch (parseError) {
                    console.error('删除响应解析失败:', parseError);
                }

                if (!response.ok) {
                    throw new Error('删除房源失败: ' + (responseData?.message || '未知错误'));
                }

                if (responseData?.success) {
                    showMessage('房源删除成功', 'success');
                    initHouseList(user.id);
                } else {
                    throw new Error('删除房源失败: ' + (responseData?.message || '未知错误'));
                }
            } catch (error) {
                console.error('删除房源失败:', error);
                // 移除重复的错误前缀
                let errorMsg = error.message;
                if (errorMsg.startsWith('删除房源失败: 删除房源失败: ')) {
                    errorMsg = errorMsg.substring(14);
                } else if (errorMsg.startsWith('删除房源失败: ')) {
                    errorMsg = errorMsg.substring(12);
                }
                showMessage('删除房源失败: ' + errorMsg, 'error');
            } finally {
                hideProgressBar();
            }
        }
    }

    // 新增房源
    // async function addHouse() {
    //     try {
    //         showProgressBar();
    //
    //         const form = document.getElementById('addHouseForm');
    //         const formData = new FormData(form);
    //
    //         const token = localStorage.getItem('token');
    //         const user = JSON.parse(localStorage.getItem('user'));
    //
    //         // 构建请求数据
    //         const houseData = {
    //             title: formData.get('title'),
    //             type: formData.get('type'),
    //             area: parseFloat(formData.get('area')),
    //             price: parseFloat(formData.get('price')),
    //             address: formData.get('address'),
    //             description: formData.get('description'),
    //             image: '' // 添加图片字段
    //         };
    //
    //         // 如果有图片文件，处理图片上传
    //         const imageFile = document.getElementById('houseImage').files[0];
    //         if (imageFile) {
    //             // 这里可以实现图片上传到服务器的逻辑
    //             // 暂时只处理图片预览，实际图片上传需要后端支持
    //             const imageUrl = URL.createObjectURL(imageFile);
    //             houseData.image = imageUrl; // 设置图片URL
    //         }
    //
    //         const response = await fetch('/api/houses', {
    //             method: 'POST',
    //             headers: {
    //                 'Content-Type': 'application/json',
    //                 'Authorization': `Bearer ${token}`
    //             },
    //             body: JSON.stringify(houseData)
    //         });
    //
    //         if (!response.ok) {
    //             throw new Error('发布房源失败');
    //         }
    //
    //         showMessage('发布房源成功', 'success');
    //         hideModal('addHouseModal');
    //         form.reset();
    //         initHouseList();
    //     } catch (error) {
    //         console.error('新增房源失败:', error);
    //         showMessage('发布房源失败', 'error');
    //     } finally {
    //         hideProgressBar();
    //     }
    // }
    // 新增房源
    async function addHouse() {
        try {
            showProgressBar();

            const form = document.getElementById('addHouseForm');
            const formData = new FormData(form);

            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));

            // 构建请求数据
            const houseData = {
                title: formData.get('title'),
                type: formData.get('type'),
                area: parseFloat(formData.get('area')),
                price: parseFloat(formData.get('price')),
                address: formData.get('address'),
                description: formData.get('description'),
                images: '[]' // 添加图片字段，默认空JSON数组
            };

            // 如果有图片文件，处理图片上传
            const imageFile = document.getElementById('houseImage').files[0];
            if (imageFile) {
                // 验证图片格式
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(imageFile.type)) {
                    throw new Error('图片格式不支持，请上传JPEG、PNG、GIF或WEBP格式的图片');
                }

                // 验证图片大小（最大2MB）
                const maxSize = 2 * 1024 * 1024;
                if (imageFile.size > maxSize) {
                    throw new Error('图片大小超过限制，请上传小于2MB的图片');
                }

                // 上传图片到后端
                const imageFormData = new FormData();
                imageFormData.append('image', imageFile);

                const imageResponse = await fetch('/api/houses/upload-image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: imageFormData
                });

                if (imageResponse.ok) {
                    const imageUrl = await imageResponse.text(); // 后端直接返回URL字符串
                    houseData.images = JSON.stringify([imageUrl]); // 将图片URL转换为JSON数组
                } else {
                    const errorText = await imageResponse.text().catch(() => '未知错误');
                    throw new Error(`图片上传失败: ${errorText}`);
                }
            } else {
                // 如果没有图片文件，设置为空数组
                houseData.images = '[]';
            }

            // 发送房源数据到后端
            const response = await fetch('/api/houses/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(houseData)
            });

            // 记录完整响应
            const responseText = await response.text();
            console.log('响应状态:', response.status);
            console.log('响应内容:', responseText);

            let responseData;
            try {
                responseData = JSON.parse(responseText);
                console.log('解析后的响应:', responseData);
            } catch (parseError) {
                console.error('响应解析失败:', parseError);
                showMessage('发布房源失败: 服务器返回无效的JSON格式', 'error');
                return;
            }

            if (response.ok && responseData.success) {
                showMessage('发布房源成功', 'success');
                hideModal('addHouseModal');
                form.reset();
                // 清空图片预览
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('imagePreview').src = '';
                // 重新加载房源列表
                initHouseList(user.id);
            } else {
                // 直接显示错误信息，不重复包装
                const errorMsg = responseData.message || responseData.error || '未知错误';
                console.error('发布房源失败:', errorMsg);
                showMessage('发布房源失败: ' + errorMsg, 'error');
            }
        } catch (error) {
            console.error('新增房源失败:', error);
            // 直接显示原始错误信息，不重复包装
            const errorMsg = error.message || '未知错误';
            showMessage('发布房源失败: ' + errorMsg, 'error');
        } finally {
            hideProgressBar();
        }
    }

    // 更新房源
    async function updateHouse() {
        try {
            showProgressBar();

            const form = document.getElementById('editHouseForm');
            const formData = new FormData(form);

            const token = localStorage.getItem('token');
            const houseId = formData.get('id');

            // 构建请求数据
            const houseData = {
                title: formData.get('title'),
                type: formData.get('type'),
                area: parseFloat(formData.get('area')),
                price: parseFloat(formData.get('price')),
                address: formData.get('address'),
                description: formData.get('description'),
                images: '[]' // 添加图片字段，默认空JSON数组
            };

            // 如果有图片文件，处理图片上传
            const imageFile = document.getElementById('editHouseImage').files[0];
            if (imageFile) {
                // 验证图片格式
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(imageFile.type)) {
                    throw new Error('图片格式不支持，请上传JPEG、PNG、GIF或WEBP格式的图片');
                }

                // 验证图片大小（最大2MB）
                const maxSize = 2 * 1024 * 1024;
                if (imageFile.size > maxSize) {
                    throw new Error('图片大小超过限制，请上传小于2MB的图片');
                }

                // 上传图片到后端
                const imageFormData = new FormData();
                imageFormData.append('image', imageFile);

                const imageResponse = await fetch('/api/houses/upload-image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: imageFormData
                });

                if (imageResponse.ok) {
                    const imageUrl = await imageResponse.text(); // 后端直接返回URL字符串
                    houseData.images = JSON.stringify([imageUrl]); // 将图片URL转换为JSON数组
                } else {
                    const errorText = await imageResponse.text().catch(() => '未知错误');
                    throw new Error(`图片上传失败: ${errorText}`);
                }
            } else {
                // 如果没有新图片，保持原有图片
                const existingHouse = await getHouseDetails(houseId);
                houseData.images = existingHouse.images || '[]';
            }

            const response = await fetch(`/api/houses/${houseId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(houseData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error('更新房源失败: ' + (errorData.message || '未知错误'));
            }

            showMessage('更新房源成功', 'success');
            hideModal('editHouseModal');
            // 清空图片预览
            document.getElementById('editImagePreview').style.display = 'none';
            document.getElementById('editImagePreview').src = '';
            const user = JSON.parse(localStorage.getItem('user'));
            initHouseList(user.id);
        } catch (error) {
            console.error('更新房源失败:', error);
            // 移除重复的错误前缀
            let errorMsg = error.message;
            if (errorMsg.startsWith('更新房源失败: 更新房源失败: ')) {
                errorMsg = errorMsg.substring(14);
            } else if (errorMsg.startsWith('更新房源失败: ')) {
                errorMsg = errorMsg.substring(12);
            }
            showMessage('更新房源失败: ' + errorMsg, 'error');
        } finally {
            hideProgressBar();
        }
    }

    // 批准预约
    async function approveAppointment(appointmentId) {
        try {
            showProgressBar();
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/appointments/${appointmentId}/approve`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('批准预约失败');
            }

            showMessage('预约已批准', 'success');
            initAppointmentList(); // 更新预约记录
        } catch (error) {
            console.error('批准预约失败:', error);
            showMessage('批准预约失败: ' + error.message, 'error');
        } finally {
            hideProgressBar();
        }
    }

    // 拒绝预约
    async function rejectAppointment(appointmentId) {
        try {
            showProgressBar();
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/appointments/${appointmentId}/reject`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('拒绝预约失败');
            }

            showMessage('预约已拒绝', 'success');
            initAppointmentList(); // 更新预约记录
        } catch (error) {
            console.error('拒绝预约失败:', error);
            showMessage('拒绝预约失败: ' + error.message, 'error');
        } finally {
            hideProgressBar();
        }
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
        initLandlordPage();

        // 初始化模态框
        initModals();

        // 登出按钮事件
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
        }
    });
</script>
</body>

</html>