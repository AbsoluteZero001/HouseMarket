<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>房屋租售系统 - 租客主页</title>
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
<header>
    <div class="container">
        <nav>
            <div class="logo">房屋租售系统</div>
            <ul class="nav-links">
                <li><a class="active" href="tenant.html">首页</a></li>
                <li><a href="#" onclick="showSection('appointment')">预约记录</a></li>
                <li><a href="#" onclick="showSection('favorites')">我的收藏</a></li>
                <li><a href="#" onclick="showSection('profile')">个人中心</a></li>
                <li><span id="username"></span></li>
                <li><a class="btn btn-secondary" href="#" id="logoutBtn">登出</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="container">
    <!-- 房源搜索和筛选 -->
    <section class="section active" id="house-search">
        <div class="filter-container">
            <h3 style="margin-bottom: 1.5rem;">房源搜索</h3>

            <form id="searchForm">
                <div class="filter-row">
                    <div class="form-group">
                        <label for="searchKeyword">关键词</label>
                        <input id="searchKeyword" name="keyword" placeholder="请输入关键词" type="text">
                    </div>

                    <div class="form-group">
                        <label for="searchType">户型</label>
                        <select id="searchType" name="type">
                            <option value="">全部户型</option>
                            <option value="平层">平层</option>
                            <option value="跃层">跃层</option>
                            <option value="错层">错层</option>
                            <option value="复式">复式</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="minArea">最小面积 (㎡)</label>
                        <input id="minArea" min="0" name="minArea" placeholder="最小" type="number">
                    </div>

                    <div class="form-group">
                        <label for="maxArea">最大面积 (㎡)</label>
                        <input id="maxArea" min="0" name="maxArea" placeholder="最大" type="number">
                    </div>
                </div>

                <div class="filter-row">
                    <div class="form-group">
                        <label for="minPrice">最低价格 (元/月)</label>
                        <input id="minPrice" min="0" name="minPrice" placeholder="最低" type="number">
                    </div>

                    <div class="form-group">
                        <label for="maxPrice">最高价格 (元/月)</label>
                        <input id="maxPrice" min="0" name="maxPrice" placeholder="最高" type="number">
                    </div>

                    <div class="form-group">
                        <label for="searchAddress">地址</label>
                        <input id="searchAddress" name="address" placeholder="请输入地址" type="text">
                    </div>
                </div>

                <div class="filter-row" style="justify-content: flex-end;">
                    <button class="btn" type="submit">搜索</button>
                    <button class="btn btn-secondary" onclick="resetFilters()" style="margin-left: 1rem;" type="reset">
                        重置
                    </button>
                </div>
            </form>
        </div>

        <!-- 房源列表 -->
        <div style="margin: 2rem 0;">
            <h3>房源列表</h3>
            <div class="house-list" id="houseList">
                <!-- 房源数据将通过JavaScript动态生成 -->
            </div>

            <!-- 分页 -->
            <ul class="pagination" id="pagination"></ul>
        </div>
    </section>

    <!-- 预约记录 -->
    <section class="section" id="appointment" style="display: none;">
        <h2 style="margin: 2rem 0;">我的预约</h2>

        <div class="card">
            <div class="card-body">
                <table class="table" id="appointmentTable">
                    <thead>
                    <tr>
                        <th>订单ID</th>
                        <th>房源</th>
                        <th>房东</th>
                        <th>预约时间</th>
                        <th>预约地点</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 预约记录将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- 我的收藏 -->
    <section class="section" id="favorites" style="display: none;">
        <h2 style="margin: 2rem 0;">我的收藏</h2>

        <div class="house-list" id="favoritesList">
            <!-- 收藏数据将通过JavaScript动态生成 -->
        </div>
    </section>

    <!-- 个人中心 -->
    <section class="section" id="profile" style="display: none;">
        <h2 style="margin: 2rem 0;">个人中心</h2>

        <div class="form-container">
            <h3>个人信息</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileUsername">用户名</label>
                    <input disabled id="profileUsername" name="username" type="text">
                </div>

                <div class="form-group">
                    <label for="profileRole">角色</label>
                    <input disabled id="profileRole" name="role" type="text">
                </div>

                <div class="form-group">
                    <label for="newPassword">新密码</label>
                    <input id="newPassword" maxlength="20" minlength="6" name="newPassword"
                           placeholder="不修改密码请留空" type="password">
                </div>

                <div class="form-group">
                    <label for="confirmNewPassword">确认新密码</label>
                    <input id="confirmNewPassword" name="confirmNewPassword" placeholder="请再次输入新密码"
                           type="password">
                </div>

                <button class="btn" type="submit">保存修改</button>
            </form>
        </div>
    </section>
</div>

<script src="assets/js/axios.js"></script>
<script>
    // 添加一个全局的axios实例，自动添加认证头
    const apiClient = axios.create({
        baseURL: '/api'
    });

    // 请求拦截器，自动添加token
    apiClient.interceptors.request.use(config => {
        const token = localStorage.getItem('token');
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    }, error => {
        return Promise.reject(error);
    });

    // 响应拦截器，处理通用错误
    apiClient.interceptors.response.use(response => {
        return response;
    }, error => {
        if (error.response && error.response.status === 401) {
            // token过期或无效，清除本地存储并跳转到登录页
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            showMessage('登录已过期，请重新登录', 'error');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }
        return Promise.reject(error);
    });

    // 验证码生成函数
    function generateCaptcha() {
        const canvas = document.getElementById('captchaCanvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // 清空画布
        ctx.fillStyle = '#f5f5f5';
        ctx.fillRect(0, 0, width, height);

        // 生成随机验证码
        const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
        let captcha = '';
        for (let i = 0; i < 4; i++) {
            captcha += chars.charAt(Math.floor(Math.random() * chars.length));
        }

        // 绘制验证码
        ctx.font = '30px Arial';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // 添加干扰线
        for (let i = 0; i < 5; i++) {
            ctx.strokeStyle = `rgb(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255})`;
            ctx.beginPath();
            ctx.moveTo(Math.random() * width, Math.random() * height);
            ctx.lineTo(Math.random() * width, Math.random() * height);
            ctx.stroke();
        }

        // 添加干扰点
        for (let i = 0; i < 30; i++) {
            ctx.fillStyle = `rgb(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255})`;
            ctx.beginPath();
            ctx.arc(Math.random() * width, Math.random() * height, 1, 0, Math.PI * 2);
            ctx.fill();
        }

        // 绘制验证码文本
        for (let i = 0; i < captcha.length; i++) {
            const x = (width / 4) * (i + 0.5);
            const y = height / 2 + (Math.random() - 0.5) * 10;
            const rotation = (Math.random() - 0.5) * 0.5;

            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(rotation);
            ctx.fillText(captcha.charAt(i), 0, 0);
            ctx.restore();
        }

        // 保存验证码到sessionStorage
        sessionStorage.setItem('captcha', captcha.toLowerCase());
    }

    // 表单验证函数
    function validateForm(formId) {
        const form = document.getElementById(formId);
        if (!form) return false;

        const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.style.borderColor = '#dc3545';
                input.addEventListener('input', () => {
                    input.style.borderColor = '#ddd';
                });
            }
        });

        return isValid;
    }

    // 显示消息函数
    function showMessage(message, type = 'success') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;

        // 添加到页面顶部
        document.body.insertBefore(messageDiv, document.body.firstChild);

        // 3秒后移除
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }

    // 图片预览功能
    function initImagePreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);

        if (input && preview) {
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        preview.src = event.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }

    // 模态框控制
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // 登出函数
    function logout() {
        // 清除用户数据
        localStorage.removeItem('token');
        localStorage.removeItem('user');

        showMessage('已成功登出', 'success');

        // 跳转到登录页
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 1500);
    }

    // 初始化所有工具函数
    document.addEventListener('DOMContentLoaded', () => {
        // 生成验证码
        if (document.getElementById('captchaCanvas')) {
            generateCaptcha();
            // 点击刷新验证码
            document.getElementById('captchaCanvas').addEventListener('click', generateCaptcha);
        }

        // 初始化模态框
        initModals();

        // 登出按钮事件
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
        }
    });
</script>
<script>
    // 租客页面JS
    function initTenantPage() {
        // 初始化房源列表
        initHouseList();

        // 搜索表单提交事件
        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            initHouseList();
        });

        // 重置筛选条件
        document.querySelector('.btn-secondary[onclick="resetFilters()"]').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('searchForm').reset();
            initHouseList();
        });

        // 初始化收藏列表
        initFavoritesList();

        // 初始化用户信息
        initUserInfo();
    }

    // 初始化用户信息
    function initUserInfo() {
        const userStr = localStorage.getItem('user');
        if (userStr) {
            const user = JSON.parse(userStr);
            document.getElementById('username').textContent = user.username;
        }
    }

    // 初始化房源列表
    async function initHouseList() {
        // 获取搜索参数
        const formData = new FormData(document.getElementById('searchForm'));
        const params = {};

        // 构建查询参数
        for (const [key, value] of formData.entries()) {
            if (value) {
                params[key] = value;
            }
        }

        try {
            const response = await apiClient.get('/houses', {params});
            const result = response.data;

            if (result.success) {
                renderHouseList(result.data.houses);
            } else {
                showMessage(result.message || '获取房源列表失败', 'error');
            }
        } catch (error) {
            console.error('获取房源列表错误:', error);
            showMessage('无法获取房源列表，请稍后重试', 'error');
        }
    }

    // 渲染房源列表
    function renderHouseList(houses) {
        const houseList = document.getElementById('houseList');

        if (!houses || houses.length === 0) {
            houseList.innerHTML = '<p style="text-align: center; color: #666; margin: 2rem 0;">没有找到符合条件的房源</p>';
            return;
        }
        
        // 获取收藏列表
        const favorites = getFavorites();

        houseList.innerHTML = houses.map(house => {
            const isFavorited = favorites.some(fav => fav.id === house.id);
            return `
        <div class="house-card">
            <img src="${house.image || 'https://picsum.photos/seed/house' + house.id + '/300/200'}" alt="${house.title}" class="house-image">
            <div class="house-info">
                <h4 class="house-title">${house.title}</h4>
                <div class="house-meta">
                    <span>户型：${house.type}</span>
                    <span>面积：${house.area}㎡</span>
                </div>
                <div class="house-price">¥${house.price}/月</div>
                <div class="house-address">${house.address}</div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn" onclick="viewHouseDetail(${house.id})">查看详情</button>
                    <button class="btn btn-secondary" onclick="bookHouse(${house.id})">预约看房</button>
                    <button class="btn btn-heart ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite(${house.id}, this)">${isFavorited ? '取消收藏' : '收藏'}</button>
                </div>
            </div>
        </div>
    `;
        }).join('');
    }

    // 初始化收藏列表
    async function initFavoritesList() {
        // 获取收藏列表
        const favorites = getFavorites();

        const favoritesList = document.getElementById('favoritesList');

        if (favorites.length === 0) {
            favoritesList.innerHTML = '<p style="text-align: center; color: #666; margin: 2rem 0;">您还没有收藏任何房源</p>';
            return;
        }

        // 渲染收藏列表
        favoritesList.innerHTML = favorites.map(house => `
        <div class="house-card">
            <img src="${house.image || 'https://picsum.photos/seed/house' + house.id + '/300/200'}" alt="${house.title}" class="house-image">
            <div class="house-info">
                <h4 class="house-title">${house.title}</h4>
                <div class="house-meta">
                    <span>户型：${house.type}</span>
                    <span>面积：${house.area}㎡</span>
                </div>
                <div class="house-price">¥${house.price}/月</div>
                <div class="house-address">${house.address}</div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn" onclick="viewHouseDetail(${house.id})">查看详情</button>
                    <button class="btn btn-secondary" onclick="bookHouse(${house.id})">预约看房</button>
                    <button class="btn btn-heart favorited" onclick="toggleFavorite(${house.id}, this)">取消收藏</button>
                </div>
            </div>
        </div>
    `).join('');
    }

    // 查看房源详情
    function viewHouseDetail(houseId) {
        window.location.href = `house-detail.html?id=${houseId}`;
    }

    // 预约看房
    function bookHouse(houseId) {
        window.location.href = `house-detail.html?id=${houseId}&action=book`;
    }

    // 获取收藏列表
    function getFavorites() {
        const favorites = localStorage.getItem('favorites');
        return favorites ? JSON.parse(favorites) : [];
    }

    // 保存收藏列表
    function saveFavorites(favorites) {
        localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    // 切换收藏状态
    function toggleFavorite(houseId, button) {
        // 先尝试从localStorage获取房源信息
        let favorites = getFavorites();
        let house = favorites.find(h => h.id === houseId);

        // 如果localStorage中没有找到房源，则从当前页面查找
        if (!house) {
            // 尝试从当前页面DOM中获取房源信息
            const houseCards = document.querySelectorAll('.house-card');
            for (let card of houseCards) {
                const viewButton = card.querySelector(`button[onclick="viewHouseDetail(${houseId})"]`);
                if (viewButton) {
                    const titleEl = card.querySelector('.house-title');
                    const typeEl = card.querySelector('.house-meta span:first-child');
                    const areaEl = card.querySelector('.house-meta span:last-child');
                    const priceEl = card.querySelector('.house-price');
                    const addressEl = card.querySelector('.house-address');
                    const imgEl = card.querySelector('.house-image');

                    if (titleEl && typeEl && areaEl && priceEl && addressEl) {
                        house = {
                            id: houseId,
                            title: titleEl.textContent,
                            type: typeEl.textContent.replace('户型：', ''),
                            area: parseFloat(areaEl.textContent.replace('面积：', '').replace('㎡', '')),
                            price: parseFloat(priceEl.textContent.replace('¥', '').replace('/月', '')),
                            address: addressEl.textContent,
                            image: imgEl ? imgEl.src : ''
                        };
                        break;
                    }
                }
            }
        }

        if (!house) {
            showMessage('无法找到房源信息', 'error');
            return;
        }

        if (button.classList.contains('favorited')) {
            // 取消收藏
            favorites = favorites.filter(fav => fav.id !== houseId);
            button.textContent = '收藏';
            button.classList.remove('favorited');
            showMessage('取消收藏成功', 'success');
        } else {
            // 添加收藏
            favorites.push(house);
            button.textContent = '取消收藏';
            button.classList.add('favorited');
            showMessage('收藏成功', 'success');
        }

        // 保存收藏列表
        saveFavorites(favorites);

        // 如果当前显示的是收藏列表，更新收藏列表
        const currentSection = document.querySelector('.section.active');
        if (currentSection && currentSection.id === 'favorites') {
            initFavoritesList();
        }
    }

    // 显示指定section
    function showSection(sectionId) {
        // 隐藏所有section
        document.querySelectorAll('.section').forEach(section => {
            section.style.display = 'none';
        });

        // 显示指定section
        document.getElementById(sectionId).style.display = 'block';

        // 更新导航激活状态
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.classList.remove('active');
        });

        // 如果是导航链接，添加激活状态
        const activeLink = document.querySelector(`.nav-links a[onclick="showSection('${sectionId}')"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }

        // 如果切换到收藏列表，初始化收藏列表
        if (sectionId === 'favorites') {
            initFavoritesList();
        }

        // 如果切换到预约记录，初始化预约记录
        if (sectionId === 'appointment') {
            // TODO: 初始化预约记录
        }

        // 如果切换到个人中心，初始化个人中心
        if (sectionId === 'profile') {
            initProfile();
        }
    }

    // 初始化个人资料
    function initProfile() {
        const userStr = localStorage.getItem('user');
        if (userStr) {
            const user = JSON.parse(userStr);
            document.getElementById('profileUsername').value = user.username;
            document.getElementById('profileRole').value = getUserRoleText(user.role);
        }
    }

    // 获取用户角色文本
    function getUserRoleText(role) {
        switch (role) {
            case 'TENANT':
                return '租客';
            case 'LANDLORD':
                return '房东';
            case 'ADMIN':
                return '管理员';
            default:
                return role;
        }
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', initTenantPage);
</script>
</body>
</html>